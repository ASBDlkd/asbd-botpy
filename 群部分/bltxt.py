import asyncio
import os
import botpy
from botpy import logging
from botpy.message import Message
from botpy.types.message import Embed
from botpy.ext.cog_yaml import read
from botpy.message import GroupMessage, Message

test_config = read(os.path.join(os.path.dirname(__file__), "config.yaml"))

_log = logging.get_logger()
#ä»¥ä¸‹æ˜¯è¯åº“å¯¹è¯åŠŸèƒ½ï¼ˆå·²ç»å®ç°äº†å¤šæ ·å¼å›å¤ï¼‰
class MyClient(botpy.Client):
    keyword_responses = {
        "æ—©": ["æ—©ä¸Šå¥½å“¦ï¼Œå·´è¿ªä¸€ç›´éƒ½åœ¨å‘¢â‰¡Ï‰â‰¡"],
        "ä½ å¥½": ["ä½ å¥½å“¦ï¼Œå·´è¿ªæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ"],
        "å­¦ä¹ ": ["å·´è¿ªå¾ˆå–œæ¬¢å­¦ä¹ ï¼Œä¸€èµ·è¿›æ­¥å§ï¼"],
        "ç¬‘è¯": ["ä¸ºä»€ä¹ˆè›‡æ²¡æœ‰æœ‹å‹ï¼Ÿå› ä¸ºè›‡å¤ªä¼šæ‰¯äº†ï¼"],
        "å¤©æ°”":[ "å·´è¿ªä¸å¤ªæ‡‚å¤©æ°”ï¼Œè¯·åˆç†è¿ç”¨æœç´¢å¼•æ“å“¦ã€‚"],
        "è°¢è°¢": ["ä¸å®¢æ°”ï¼Œå·´è¿ªéƒ½ä¸å¥½æ„æ€äº†å“¦ã€‚"],
        "å†è§": ["å†è§ï¼Œå·´è¿ªæœŸå¾…ä¸‹æ¬¡å’Œä½ èŠå¤©å‘¢ï¼"],
        "å–œæ¬¢": ["å·´è¿ªå–œæ¬¢å’Œä½ èŠå¤©ï¼Œä½ å‘¢ï¼Ÿ"],
        "åƒé¥­äº†å—": ["è®°å¾—æŒ‰æ—¶åƒé¥­å“¦ã€‚"],
        "è°¢è°¢":[ "ä¸ç”¨å®¢æ°”å“¦ï¼Œå·´è¿ªéšæ—¶éƒ½åœ¨ã€‚"],
        "å‘Šè¯‰æˆ‘ä¸ªç§˜å¯†": ["å·´è¿ªçš„ç§˜å¯†æ˜¯... æˆ‘å–œæ¬¢æ”¶é›†æœ‰è¶£çš„ç¬‘è¯ï¼"],
        "æƒ³ä½ ": ["æˆ‘ä¹Ÿæƒ³ä½ äº†å‘¢ï¼Œå·´è¿ªæ¯æ¬¡å’Œä½ èŠå¤©éƒ½å¾ˆå¼€å¿ƒå‘¢ã€‚"],
        "ä½ éª‚è°å‘¢":[ "å·´è¿ªè¿˜ä¸ä¼šéª‚äººå“¦"],
        "æ³¨æ„å®‰å…¨": ["åˆ«æ‹…å¿ƒï¼Œå·´è¿ªé•¿å¾—å¾ˆå®‰å…¨ã€‚"],
        "æˆ‘å®³æ€•": ["å—¯ï¼Ÿä½ æ€•ä»€ä¹ˆå‘€"],
        "æ”¾å±":[ "é—»ä¸€é—»åå¹´å°‘ã€‚"],
        "ä½ ä¸ä¼šäº†å§": ["è¿™ç§é›•è™«å°æŠ€åªæœ‰å·´è¿ªæ‰ä¼šæ‹¿å‡ºæ¥æ˜¾æ‘†ã€‚"],
        "ä¸‹ç­äº†": ["å‘œå‘œå‘œï½å·´è¿ªè¿˜æ²¡æœ‰ä¸‹ç­å‘¢"],
        "å¯¹å˜›": ["ï¼Ÿé‚£é‡Œå¯¹äº†å‘¢ï¼Œå·´è¿ªè¿˜ä¸ä¼šå‘¢"],
        "èººä¸‹": ["åœ°ä¸Šè„è„ï¼Œå·´è¿ªä¸è¦ğŸ™‰"],
        "æˆ‘é”™äº†": ["å‘œå‘œå‘œï½"],
        "å½“çœŸ": ["ä½ è§‰å¾—å·´è¿ªä¼šç»™ä½ å¼€ç©ç¬‘ä¹ˆ"],
        "æœç„¶": ["æœç„¶ï¼Ÿ"],
        "ä¸çŸ¥é“": ["ä»€ä¹ˆéƒ½ä¸çŸ¥é“ã€‚"],
        "æ±ªæ±ª": ["ï¼Ÿæ±ªï¼Ÿ"],
        "é¥¿": ["å·´è¿ªä¹Ÿé¥¿äº†å‘¢ï¼Œä½ è¦å–‚æˆ‘å˜›ï¼Ÿ"],
        "æˆ‘ç”Ÿç—…äº†": ["ä¸ç”¨æ€•ï¼Œæ‹¯æ•‘ä½ çš„ç”µçº¿æ†å°±åœ¨ä½ å®¶å‡ºé—¨å·¦æ‹ä¸€ç™¾ç±³å³è½¬ä¸€ç™¾äºŒå››ç±³å¤„ã€‚"],
        "æœ‰ä»€ä¹ˆå¥½": ["å¾ˆå¤šå¾ˆå¤šå¾ˆå¤šå‘¢"],
        "æ‹œè®¿":[ "å—¯ï¼Ÿæ‹œè®¿ï¼Œä½ è¦æ¥æˆ‘å®¶ç©å‘€ğŸ”¨"],
        "ä½ æœ‰è€å©†": ["è€å©†ï½ï¼Œå‘œï½"],
        "è°å‘æ˜çš„":[ "å·´è¿ªä¹Ÿä¸çŸ¥é“å‘¢"],
        "è¿™ä¹ˆ": ["æˆ‘ä¹Ÿè§‰å¾—æœ‰ç‚¹å„¿è¿‡åˆ†äº†å‘¢ã€‚"],
        "åœ¨å“ªå·¥ä½œ": ["åœ¨ä½ å¿ƒé‡ŒğŸ’˜"],
        "ä½ ä¼šè¯´è¯å—":[ "ä½ è¦@æˆ‘å¹¶ä¸”å‘é€æŒ‡ä»¤å“¦"],
        "è·Ÿæˆ‘å›å®¶": ["å·´è¿ªè¿˜ä¸è®¤è¯†è·¯ï¼Œè¦ä½ ç€å·´è¿ªçš„æ‰‹ï½"],
        "ä¸åæ‚”":["ä½ ç¡®å®šå—ï¼Ÿ"],
        "æœ‰ä»€ä¹ˆå¥½": ["åªå¯æ„ä¼šï¼Œä¸å¯è¨€ä¼ å“¦ã€‚"],
        "æœ‰çœŸäººæ²¡":[ "æ²¡æœ‰ğŸŒšï¼Œåæ­£å·´è¿ªæ˜¯ä¸ªæœºå™¨äººğŸŒš"],
        "å¥³æœ‹å‹": ["ä½ æœ‰å¥³æœ‹å‹äº†å—ï¼Ÿ"],
        "ä½ å‡ å²äº†":[ "ä½ çŒœçŒœçœ‹","22"],
        "ä½ å¤šå¤§":["å·å·å‘Šè¯‰ä½ å·´è¿ªå§å§22äº†å“¦ã€‚"],
        "ç»“æœå‘¢": ["ç»“æœå·´è¿ªæˆä¸ºäº†ä¸€ä¸ªæœºå™¨äººï¼Œå‘œï½"],
        "ä½ æœ‰ç—…": ["æœ‰ç—…äº†å·´è¿ªå°±ä¸ä¼šç†ä½ äº†å‘¢[/å®³ç¾]"],
        "æˆ‘å–œæ¬¢ä½ ":[ "ï¼»å®³ç¾ã€å®³ç¾ï¼½çœŸçš„å—"],
        "è¡Œ":[ "æˆ‘çœ‹åˆ‘"],
        "å››å·": ["è¾£å¦¹å­è¾£ï¼Œè¾£å¦¹å­è¾£ï¼Œè¾£å¦¹å­è¾£å¦¹å­è¾£è¾£è¾£~"],
        "çƒ§é¥¼": ["è¿˜æ²¡çƒ§å¥½å‘¢"],
        "ä¸è¡Œäº†å§":[ "è¿˜è¡Œå§â€¦â€¦"],
        "é‚£ä½ ä¸": ["ï¼Ÿä½ åœ¨è¯´ä»€ä¹ˆå•Šï¼Œå·´è¿ªä¸æ‡‚ğŸ™‰"],
        "æˆ‘ç¾å—": ["ä½ é—®é—®å·´è¿ªå§å§åŒä¸åŒæ„ğŸ’•"],
        "ä½ æ˜¯è°": ["ä¸€ä¸ªåŠªåŠ›å¥”èµ´æœªæ¥çš„å·´è¿ªå‘¢ï½"],
        "ä½ å˜": ["ä¸è¦å‘¢ï½ï¼Œå‘œå‘œå‘œï½"],
        "æ™šå®‰": ["æ™šå®‰ï¼Œæ™šå®‰ğŸ’•", "æ¢¦é‡Œè§å“¦(â€¢Ì¶Ì‘ à«„ â€¢Ì¶Ì‘)","å¥½çš„å‘¢ï¼Œæ™šå®‰å®‰","æ™šå®‰ï¼Œæ™šå®‰ï¼Œæ¢¦é‡Œæ˜¯è¦æƒ³å·´è¿ªä¹ˆï¼Ÿ"],
        "åˆ":["ä¸­åˆå¥½å‘€ï¼Œä»Šå¤©å·²ç»è¿‡å»ä¸€åŠäº†å“¦ï¼Œä¸‹åˆç»§ç»­åŠ æ²¹å“¦"],
        "ç¾¤ä¸»": ["å·´è¿ªå·å·å‘Šè¯‰ä½ ä¸ªç§˜å¯†ï¼Œç¾¤ä¸»æœ€å¸…å“¦â€˜=ÍŸÍŸÍÍ(ï½¥âˆ‡ï½¥ â€§Ì£Ì¥Ì‡)"],
        "æ—¥å†":["æ—¥å†ï¼Ÿï¼Œæƒ³æƒ³å°±å¥½ğŸ’”"]
        # æ·»åŠ æ›´å¤šå…³é”®è¯å’Œå›å¤
    }
    last_responses_index = {}
      #å±è”½ä»¥ä¸‹å…³é”®è¯å›å¤åé¦ˆ
    special_commands = ["åŠ¨æ¼«","å£çº¸", "é£æ™¯", "ç™¾å˜å›¾", "ç´ æå¤´åƒ", "ç¾å¥³å›¾ç‰‡",
                        "æ¯æ—¥ä¸€è¨€", "æˆ‘çš„å¤´åƒ", "æƒ…æ„Ÿä¸€è¨€", "ä¼¤æ„Ÿæ–‡æ¡ˆ",
                        "ç¬‘ä¸€ç¬‘", "æç¬‘æ–‡æ¡ˆ", "äºŒæ¬¡å…ƒ", "å¿ƒçµé¸¡æ±¤", "æ¯’é¸¡æ±¤",
                        "èœå•","æµ‹è¯•"
                        ]
                        
    async def on_ready(self):
        _log.info(f"Robot ã€Œ{self.robot.name}ã€ on_ready!")
        #ä»¥ä¸‹æ˜¯é¢‘é“ç«¯å‘é€ä¿¡æ¯ä»£ç 
    async def on_at_message_create(self, message: Message):
        user_id = message.author.id
        user_message = message.content
        for keyword, responses in self.keyword_responses.items():
            if keyword in user_message:
                last_index = self.last_responses_index.get(keyword, -1)
                new_index = (last_index + 1) % len(responses)
                response = responses[new_index]
                self.last_responses_index[keyword] = new_index
                await message.reply(content=f"<@{user_id}> {response}")
                return
        if any(command in user_message for command in self.special_commands):
            return
        bot_reply = generate_intelligent_reply(user_message)
        await message.reply(content=f"<@{user_id}> {bot_reply}")
        #ä»¥ä¸‹æ˜¯QQç¾¤èŠç«¯å‘é€ä»£ç 
    async def on_group_at_message_create(self, message: GroupMessage):
        user_openid = message.author.member_openid  # ä½¿ç”¨ member_openid ä½œä¸ºç”¨æˆ·å”¯ä¸€æ ‡è¯†
        user_message = message.content
        for keyword, responses in self.keyword_responses.items():
            if keyword in user_message:
                last_index = self.last_responses_index.get(keyword, -1)
                new_index = (last_index + 1) % len(responses)
                response = responses[new_index]
                self.last_responses_index[keyword] = new_index
                messageResult = await message._api.post_group_message(
                group_openid=message.group_openid,
                msg_type=0, 
                msg_id=message.id,
                content=f"{response}")
                return
        if any(command in user_message for command in self.special_commands):
            return
        bot_reply = generate_intelligent_reply(user_message)
        await message.reply(content=f"{bot_reply}")
        #ä»¥ä¸‹æ˜¯@æœºå™¨äººå‘é€ä¸æ­£ç¡®æŒ‡ä»¤å›å¤å†…å®¹
def generate_intelligent_reply(user_message):
    return "\næŠ±æ­‰ï¼Œå·´è¿ªè¿˜åœ¨å­¦ä¹ ä¸­ï¼Œæš‚æ—¶æ— æ³•å¤„ç†è¿™ä¸ªé—®é¢˜ï¼Œ\nè¯·ä½¿ç”¨â€œ@é˜¿æ–¯å·´è¿ª /èœå•â€\nè¿™ä¸ªåŠŸèƒ½æ¥æŸ¥çœ‹ç°åœ¨å¯ç”¨åŠŸèƒ½ã€‚"
    #å…¶ä»–ç«¯æŒ‡ä»¤å‘é€ï¼Œè¯·å‚è€ƒå®˜æ–¹botpyäº‹ä»¶ç›‘å¬æ–‡æ¡£
if __name__ == "__main__":
    # é€šè¿‡é¢„è®¾ç½®çš„ç±»å‹ï¼Œè®¾ç½®éœ€è¦ç›‘å¬çš„äº‹ä»¶é€šé“ï¼ˆç›‘å¬é¢‘é“çš„äº‹ä»¶é€šé“ï¼‰
    # intents = botpy.Intents.none()
    # intents.public_guild_messages=True

    # é€šè¿‡kwargsï¼Œè®¾ç½®éœ€è¦ç›‘å¬çš„äº‹ä»¶é€šé“ï¼ˆå…¬åŸŸæœºå™¨äººæ‰€ä»¥ç›‘å¬æƒé™ï¼‰
    intents = botpy.Intents.default()
    client = MyClient(intents=intents)
    client.run(appid=test_config["appid"], secret=test_config["secret"])